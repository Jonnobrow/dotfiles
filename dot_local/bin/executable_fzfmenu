#!/bin/sh
FZF_DEFAULT_OPTS=
profile=
dmenu=
scratchpad=
powermenu=

while getopts pdsx opt; do
  case $opt in
  p) profile=1 ;;
  d) dmenu=1 ;;
  s) scratchpad=1 ;;
  x) powermenu=1;;
  ?)
    printf 'Usage: %s -p|-d|-s|-x\n' "$0"
    exit 2
    ;;
  esac
done

if [ -n "$profile" ]; then
  temp=$(mktemp)
  foot -T 'foot-float' \
    sh -c "fd -t d -d 1 -I '[a-zA-Z0-9]\.+' --base-directory ~/.mozilla/firefox\
    | fzf --no-sort > $temp"
  if [ -s "$temp" ]; then
    nohup firefox --profile "$HOME"/.mozilla/firefox/"$(cat "$temp")" >/dev/null 2>&1 &
  else
    printf '%s is empty' "$temp"
  fi
fi

if [ -n "$dmenu" ]; then
  foot -T 'foot-float' sh -c "fzf --no-sort < /proc/$$/fd/0 > /proc/$$/fd/1"
fi

# Inspired by
# https://github.com/shervinsahba/dotfiles/blob/main/src/scratchpad-rofi
if [ -n "$scratchpad" ]; then
    scratch=$(swaymsg -t get_tree | jq '.nodes[] | .nodes[] | select(.name=="__i3_scratch") | .floating_nodes[] | [.pid,.name]' | \
        sed '/^[][]*$/d' | sed '/,$/{N;s/\n//}' | tr -d "\"" | sed 's/,/ -/g' | sed 's/^[[:space:]]//g')
    temp=$(mktemp)
    foot -T 'foot-float' sh -c "echo \"$scratch\" | fzf --no-sort > $temp"
    if [ -s "$temp" ]; then
        pid=$(cat $temp | perl -nE 'my($id) = split("-"); $id =~ tr/ //d; if($id){say $id}')
        nohup swaymsg "[pid=\"$pid\"] scratchpad show" >/dev/null 2>&1 &
    fi
fi

if [ -n "$powermenu" ]; then
    options="shutdown - shutdown now
reboot - reboot 
reload - swaymsg \"reload\" 
exit - swaymsg \"exit\""
    temp=$(mktemp)
    foot -T 'foot-float' sh -c "echo \"$options\" | fzf --no-sort > $temp"
    if [ -s "$temp" ]; then
        cmd=$(cat $temp | cut -d"-" -f2)
        exec $cmd
    fi
fi
